name: BNOC Pages (hub+feed)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  BASE_PATH: /BNOC

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate hub, feed, latest
        run: |
          python3 - << 'PY'
          import os, re, html, json, subprocess, datetime, pathlib

          OWNER = os.getenv("GITHUB_REPOSITORY_OWNER","")
          REPO  = os.getenv("GITHUB_REPOSITORY","").split("/")[-1] if os.getenv("GITHUB_REPOSITORY") else ""
          BASE  = os.getenv("BASE_PATH", f"/{REPO}" if REPO else "")
          HOST  = f"https://{OWNER}.github.io"

          def find_issue_dirs():
              items = []
              for d in sorted(os.listdir('.')):
                  if not os.path.isdir(d):
                      continue
                  if d.startswith(('.', '_', 'assets', '.git')):
                      continue
                  if re.fullmatch(r'\d{8}', d):
                      items.append(d)
              return items

          def parse_date_from_folder(name):
              s = name
              if re.fullmatch(r'\d{8}', s):
                  mm, dd, yyyy = int(s[:2]), int(s[2:4]), int(s[4:])
                  if 1 <= mm <= 12 and 1 <= dd <= 31 and 2000 <= yyyy <= 2100:
                      return f"{yyyy:04d}-{mm:02d}-{dd:02d}"
                  yyyy, mm, dd = int(s[:4]), int(s[4:6]), int(s[6:])
                  if 2000 <= yyyy <= 2100 and 1 <= mm <= 12 and 1 <= dd <= 31:
                      return f"{yyyy:04d}-{mm:02d}-{dd:02d}"
              return None

          def git_date(path):
              try:
                  out = subprocess.check_output(
                      ["git", "log", "-1", "--format=%aI", "--", path],
                      text=True
                  ).strip()
                  if out:
                      return out[:10]
              except Exception:
                  pass
              return None

          # 이슈 메타데이터 수집
          issues = []
          for d in find_issue_dirs():
              htmls = [f for f in os.listdir(d) if f.lower().endswith(".html")]
              if not htmls:
                  continue
              filename = "index.html" if "index.html" in htmls else htmls[0]
              p = os.path.join(d, filename)
              raw = open(p, encoding="utf-8", errors="ignore").read()
              t = re.search(r'<title>(.*?)</title>', raw, re.I | re.S)
              m = re.search(r'<meta\s+name=["\']date["\']\s+content=["\'](.*?)["\']', raw, re.I)
              title = html.escape(t.group(1).strip()) if t else f"#{d}"
              date = (m.group(1).strip() if m else None) \
                     or parse_date_from_folder(d) \
                     or git_date(d) or git_date(p) \
                     or datetime.date.today().isoformat()
              link = f"{BASE}/{d}/" if filename.lower() == "index.html" else f"{BASE}/{d}/{filename}"
              issues.append({"dir": d, "title": title, "date": date, "link": link})

          issues.sort(key=lambda x: (x["date"], x["link"]), reverse=True)
          pathlib.Path(".nojekyll").write_text("")

          # index.json 저장
          open("index.json", "w", encoding="utf-8").write(
              json.dumps({"items": issues}, ensure_ascii=False, indent=2)
          )

          # ----- 허브(index.html) UI 템플릿 (개선된 디자인 적용) -----

          # 리스트 아이템 HTML 생성 (카드 스타일)
          items = "\n".join([
              f'''
              <a href="{it["link"]}" class="card item-card">
                <div class="item-meta">
                  <span class="item-date">{it["date"]}</span>
                </div>
                <h3 class="item-title">{it["title"]}</h3>
                <div class="item-arrow">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
                </div>
              </a>
              ''' for it in issues
          ])
          
          if not items:
              items = '<div class="card empty-card"><p>아직 발행된 호가 없습니다.</p></div>'

          # Random용 링크 배열
          links_json = json.dumps([it["link"] for it in issues], ensure_ascii=False)

          # 템플릿 HTML (Midnight Slate & Glassmorphism Theme)
          hub_template = """<!doctype html>
          <html lang="ko">
          <head>
            <meta charset="utf-8" />
            <title>BNOC — Weekly</title>
            <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
            
            <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
            <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;0,900;1,300&display=swap" rel="stylesheet">

            <style>
              :root {
                /* Color Palette */
                --bg-body: #0a0e14;
                --bg-gradient-start: #111827;
                --bg-gradient-end: #020408;
                
                --card-bg: rgba(23, 30, 41, 0.7);
                --card-border: rgba(255, 255, 255, 0.08);
                --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                
                --text-main: #e2e8f0;
                --text-muted: #94a3b8;
                --text-highlight: #f8fafc;
                
                --accent-primary: #10b981; /* Emerald */
                --accent-secondary: #f59e0b; /* Amber */
                
                --font-sans: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
                --font-serif: "Merriweather", serif;

                --radius-lg: 20px;
                --radius-md: 12px;
                --radius-sm: 8px;
              }

              @media (prefers-color-scheme: light) {
                :root {
                  --bg-body: #f8fafc;
                  --bg-gradient-start: #f1f5f9;
                  --bg-gradient-end: #e2e8f0;
                  
                  --card-bg: rgba(255, 255, 255, 0.85);
                  --card-border: rgba(0, 0, 0, 0.06);
                  --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
                  
                  --text-main: #1e293b;
                  --text-muted: #64748b;
                  --text-highlight: #0f172a;
                  
                  --accent-primary: #059669;
                  --accent-secondary: #d97706;
                }
              }

              /* Base */
              * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
              html, body { margin: 0; padding: 0; height: 100%; }
              body {
                font-family: var(--font-sans);
                background: radial-gradient(circle at top center, var(--bg-gradient-start) 0%, var(--bg-body) 60%, var(--bg-gradient-end) 100%);
                color: var(--text-main);
                line-height: 1.6;
                -webkit-font-smoothing: antialiased;
              }
              
              .wrap {
                max-width: 680px;
                margin: 0 auto;
                padding: 0 16px 80px;
              }

              /* Header */
              header {
                padding: 24px 0 32px;
                display: flex;
                flex-direction: column;
                gap: 20px;
              }
              .brand {
                display: flex;
                gap: 14px;
                align-items: center;
              }
              .logo {
                width: 42px;
                height: 42px;
                border-radius: 12px;
                background: linear-gradient(135deg, var(--accent-primary), #064e3b);
                box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
                position: relative;
              }
              .logo::after {
                content: ''; position: absolute; inset: 0;
                border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);
              }
              
              .title-group { display: flex; flex-direction: column; }
              .title {
                font-family: var(--font-serif);
                font-size: 20px;
                font-weight: 900;
                color: var(--text-highlight);
                letter-spacing: -0.01em;
              }
              .subtitle {
                font-size: 13px;
                color: var(--text-muted);
                line-height: 1.4;
                max-width: 400px;
              }

              /* Navigation */
              .nav-links {
                display: flex;
                gap: 10px;
              }
              .btn {
                appearance: none;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 16px;
                border-radius: 99px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                border: 1px solid var(--card-border);
                background: rgba(255,255,255,0.03);
                color: var(--text-muted);
                transition: all 0.2s ease;
                font-family: var(--font-sans);
              }
              .btn b { color: var(--text-main); }
              .btn:hover {
                background: rgba(255,255,255,0.08);
                transform: translateY(-1px);
                color: var(--text-highlight);
              }
              .btn.active {
                background: rgba(16, 185, 129, 0.1);
                border-color: rgba(16, 185, 129, 0.3);
                color: var(--accent-primary);
              }
              .btn.active b { color: var(--accent-primary); }

              /* About Panel */
              .about-panel {
                display: none;
                margin-bottom: 30px;
                padding: 24px;
                background: var(--card-bg);
                border: 1px solid var(--card-border);
                border-radius: var(--radius-lg);
                box-shadow: var(--card-shadow);
                backdrop-filter: blur(10px);
                animation: slideDown 0.3s ease-out;
              }
              .about-panel.open { display: block; }
              .about-panel h2 {
                margin: 0 0 8px;
                font-family: var(--font-serif);
                font-size: 18px;
                color: var(--text-highlight);
              }
              .about-panel h3 {
                margin: 20px 0 6px;
                font-size: 14px;
                font-weight: 700;
                color: var(--accent-primary);
              }
              .about-panel p, .about-panel li {
                font-size: 14px;
                color: var(--text-muted);
                line-height: 1.7;
              }
              .about-panel ul { padding-left: 20px; margin: 8px 0; }
              
              @keyframes slideDown {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
              }

              /* Main List */
              .section-label {
                font-size: 12px;
                font-weight: 600;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.05em;
                margin-bottom: 12px;
                padding-left: 4px;
                opacity: 0.8;
              }

              .grid {
                display: grid;
                gap: 12px;
                animation: fadeUp 0.6s ease-out;
              }

              .card {
                background: var(--card-bg);
                border: 1px solid var(--card-border);
                box-shadow: var(--card-shadow);
                backdrop-filter: blur(10px);
                border-radius: var(--radius-lg);
                overflow: hidden;
              }
              
              .item-card {
                display: flex;
                flex-direction: column;
                padding: 20px 22px;
                text-decoration: none;
                transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                position: relative;
              }
              .item-card:hover {
                background: rgba(255,255,255,0.03); /* subtle highlight */
                border-color: rgba(255,255,255,0.15);
                transform: translateY(-2px);
                box-shadow: 0 12px 40px rgba(0,0,0,0.2);
              }
              .item-card:active { transform: scale(0.98); }

              .item-meta {
                margin-bottom: 8px;
              }
              .item-date {
                font-size: 11px;
                font-family: var(--font-sans);
                background: rgba(255,255,255,0.06);
                padding: 4px 10px;
                border-radius: 99px;
                color: var(--accent-secondary);
                font-weight: 600;
                letter-spacing: 0.02em;
              }
              
              .item-title {
                margin: 0;
                font-family: var(--font-serif);
                font-size: 16px;
                font-weight: 700;
                color: var(--text-main);
                line-height: 1.5;
                padding-right: 24px;
              }
              
              .item-arrow {
                position: absolute;
                right: 20px;
                bottom: 20px;
                color: var(--text-muted);
                opacity: 0.5;
                transition: transform 0.2s;
              }
              .item-card:hover .item-arrow {
                opacity: 1;
                color: var(--accent-primary);
                transform: translateX(3px);
              }

              .empty-card {
                padding: 40px;
                text-align: center;
                color: var(--text-muted);
                font-size: 14px;
              }

              /* Footer */
              footer {
                margin-top: 40px;
                padding-top: 24px;
                border-top: 1px solid var(--card-border);
                text-align: center;
              }
              footer p {
                font-size: 12px;
                color: var(--text-muted);
                line-height: 1.6;
                margin: 0 0 12px;
                opacity: 0.7;
              }
              .footer-links a {
                font-size: 11px;
                color: var(--text-muted);
                text-decoration: none;
                margin: 0 6px;
                border-bottom: 1px dotted var(--text-muted);
              }
              .footer-links a:hover { color: var(--text-highlight); border-bottom-style: solid; }

              @keyframes fadeUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
              }
            </style>
          </head>
          <body>
            <div class="wrap">
              <header>
                <div class="brand">
                  <div class="logo" aria-hidden="true"></div>
                  <div class="title-group">
                    <div class="title">BNOC — Weekly</div>
                    <div class="subtitle">
                      성경 본문을 정론(orthodoxy)와 정행(orthopraxy)의 틀로 읽어내는 모바일 가이드
                    </div>
                  </div>
                </div>
                <nav class="nav-links">
                  <button class="btn" type="button" id="btnAbout">
                    <b>About</b> <span>소개</span>
                  </button>
                  <button class="btn" type="button" id="btnRandom">
                    <b>Random</b> <span>아무거나</span>
                  </button>
                  <a class="btn" href="__BASE__/latest/">
                    <b>Latest</b> <span>최근 호</span>
                  </a>
                </nav>
              </header>

              <main>
                <div id="aboutPanel" class="about-panel">
                  <h2>BNOC — Weekly 소개</h2>
                  <p>
                    BNOC(Bible Notes on Context)는 성경 본문을 <b>정론(orthodoxy)</b>과 <b>정행(orthopraxy)</b>의 균형 잡힌 시각으로 읽어 보는 모바일 가이드 아카이브입니다.
                  </p>
                  <h3>1) 무엇을 다루나요?</h3>
                  <p>
                    매 호마다 하나의 본문을 선정하여 <b>역사·지리적 배경</b>, <b>교리적 정론</b>, 그리고 <b>실천적 정행</b>과 현대적 적용을 정리합니다.
                  </p>
                  <h3>2) 사용 가이드</h3>
                  <ul>
                    <li>흐름을 따라 읽으며 본문의 입체적인 의미를 파악합니다.</li>
                    <li>“오늘 나는 누구의 이웃이 될까?”와 같은 실천적 질문을 품습니다.</li>
                    <li>소그룹이나 개인 묵상 시간에 나눔의 재료로 활용합니다.</li>
                  </ul>
                  <h3>3) 지향점</h3>
                  <p>
                    완벽한 정답보다는 텍스트와 씨름할 수 있는 <b>건강한 프레임</b>을 제공하는 것을 목표로 합니다.
                  </p>
                </div>

                <div class="section-label">Publications</div>
                <div class="grid">
                  __ITEMS__
                </div>

                <footer>
                  <p>
                    BNOC (Bible Notes on Context)는 개인 연구용 아카이브입니다.<br />
                    GitHub Pages를 통해 자동으로 빌드 및 배포됩니다.
                  </p>
                  <div class="footer-links">
                    <a href="__BASE__/feed.xml">RSS Feed</a>
                    <a href="__BASE__/sitemap.xml">Sitemap</a>
                  </div>
                </footer>
              </main>
            </div>
            
            <script>
              window.BNOC_LINKS = __LINKS__;
              (function() {
                var panel = document.getElementById('aboutPanel');
                var btn = document.getElementById('btnAbout');
                if (panel && btn) {
                  btn.addEventListener('click', function() {
                    var isOpen = panel.classList.toggle('open');
                    btn.classList.toggle('active');
                  });
                }

                var randomBtn = document.getElementById('btnRandom');
                if (randomBtn && Array.isArray(window.BNOC_LINKS) && window.BNOC_LINKS.length > 0) {
                  randomBtn.addEventListener('click', function() {
                    var links = window.BNOC_LINKS;
                    var idx = Math.floor(Math.random() * links.length);
                    window.location.href = links[idx];
                  });
                }
              })();
            </script>
          </body>
          </html>
          """

          hub = (
              hub_template
              .replace("__BASE__", BASE)
              .replace("__ITEMS__", items)
              .replace("__LINKS__", links_json)
          )
          open("index.html", "w", encoding="utf-8").write(hub)
          # ----- 허브 템플릿 끝 -----

          # RSS(feed.xml)
          def esc(s):
              return s.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")

          now = datetime.datetime.utcnow().strftime("%a, %d %b %Y %H:%M:%S +0000")
          rss = [
              '<?xml version="1.0" encoding="UTF-8"?>',
              '<rss version="2.0"><channel>',
              '<title>BNOC Weekly</title>',
              f'<link>{HOST}{BASE}/</link>',
              '<description>Weekly BNOC newsletters</description>',
              '<language>ko</language>',
              f'<lastBuildDate>{now}</lastBuildDate>'
          ]
          for it in issues[:50]:
              pub = datetime.datetime.fromisoformat(it["date"]).strftime(
                  "%a, %d %b %Y 00:00:00 +0000"
              )
              rss.append(
                  f'<item><title>{esc(it["title"])}</title>'
                  f'<link>{HOST}{it["link"]}</link>'
                  f'<guid isPermaLink="true">{HOST}{it["link"]}</guid>'
                  f'<pubDate>{pub}</pubDate></item>'
              )
          rss.append('</channel></rss>')
          open("feed.xml", "w", encoding="utf-8").write("".join(rss))

          # sitemap.xml
          urls = [f"{HOST}{BASE}/"] + [f"{HOST}{it['link']}" for it in issues]
          sm = ['<?xml version="1.0" encoding="UTF-8"?>',
                '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">']
          sm += [f"<url><loc>{u}</loc></url>" for u in urls]
          sm.append("</urlset>")
          open("sitemap.xml", "w", encoding="utf-8").write("\n".join(sm))

          # latest redirect
          if issues:
              os.makedirs("latest", exist_ok=True)
              open("latest/index.html", "w", encoding="utf-8").write(
                  f'<!doctype html><meta charset="utf-8"><meta http-equiv="refresh" content="0; url={issues[0]["link"]}"><link rel="canonical" href="{issues[0]["link"]}">'
              )

          PY

      - uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - uses: actions/deploy-pages@v4
